{
  "url": "https://developers.cloudflare.com/support/troubleshooting/restoring-visitor-ips/restoring-original-visitor-ips/#_top",
  "title": "Restoring original visitor IPs - Cloudflare Support docsYesNoYesNo",
  "keyword": "",
  "content": "Skip to content          Cloudflare Docs            Search            Products  Learning  Status  Support  Log in   GitHub X YouTube       Select theme    DarkLightAuto        \n\tStarlightThemeProvider.updatePickers();\n const r=\"starlight-theme\",o=e=>e===\"auto\"||e===\"dark\"||e===\"light\"?e:\"auto\",c=()=>o(typeof localStorage<\"u\"&&localStorage.getItem(r));function n(e){typeof localStorage<\"u\"&&localStorage.setItem(r,e===\"light\"||e===\"dark\"?e:\"\")}const l=()=>matchMedia(\"(prefers-color-scheme: light)\").matches?\"light\":\"dark\";function t(e){StarlightThemeProvider.updatePickers(e),document.documentElement.dataset.theme=e===\"auto\"?l():e,n(e)}matchMedia(\"(prefers-color-scheme: light)\").addEventListener(\"change\",()=>{c()===\"auto\"&&t(\"auto\")});class s extends HTMLElement{constructor(){super(),t(c()),this.querySelector(\"select\")?.addEventListener(\"change\",a=>{a.currentTarget instanceof HTMLSelectElement&&t(o(a.currentTarget.value))})}}customElements.define(\"starlight-theme-select\",s); class n extends HTMLElement{constructor(){super();const e=this.querySelector(\"select\");e&&e.addEventListener(\"change\",t=>{t.currentTarget instanceof HTMLSelectElement&&(window.location.pathname=t.currentTarget.value)})}}customElements.define(\"starlight-lang-select\",n);           class s extends HTMLElement{constructor(){super(),this.btn=this.querySelector(\"button\"),this.btn.addEventListener(\"click\",()=>this.toggleExpanded());const t=this.closest(\"nav\");t&&t.addEventListener(\"keyup\",e=>this.closeOnEscape(e))}setExpanded(t){this.setAttribute(\"aria-expanded\",String(t)),document.body.toggleAttribute(\"data-mobile-menu-expanded\",t)}toggleExpanded(){this.setExpanded(this.getAttribute(\"aria-expanded\")!==\"true\")}closeOnEscape(t){t.code===\"Escape\"&&(this.setExpanded(!1),this.btn.focus())}}customElements.define(\"starlight-menu-button\",s);              Support      \n\t\t(() => {\n\t\t\ttry {\n\t\t\t\tif (!matchMedia('(min-width: 50em)').matches) return;\n\t\t\t\t/** @type {HTMLElement | null} */\n\t\t\t\tconst target = document.querySelector('sl-sidebar-state-persist');\n\t\t\t\tconst state = JSON.parse(sessionStorage.getItem('sl-sidebar-state') || '0');\n\t\t\t\tif (!target || !state || target.dataset.hash !== state.hash) return;\n\t\t\t\twindow._starlightScrollRestore = state.scroll;\n\t\t\t\tcustomElements.define(\n\t\t\t\t\t'sl-sidebar-restore',\n\t\t\t\t\tclass SidebarRestore extends HTMLElement {\n\t\t\t\t\t\tconnectedCallback() {\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\tconst idx = parseInt(this.dataset.index || '');\n\t\t\t\t\t\t\t\tconst details = this.closest('details');\n\t\t\t\t\t\t\t\tif (details && typeof state.open[idx] === 'boolean') details.open = state.open[idx];\n\t\t\t\t\t\t\t} catch {}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t} catch {}\n\t\t})();\n\t     Overview     Contacting Cloudflare Support        About Cloudflare         Overview        Support - Enterprise Documentation         Overview     Customer Incident Management Policy                Account Management & Billing         Overview        Billing Cloudflare Plans         Overview     Cloudflare Billing Policy     Understanding Cloudflare sales tax         Cannot locate dashboard account     Understanding Billing for Add-on Services            More Dashboard Apps         Overview        Cloudflare Apps         Overview     Managing Cloudflare Apps     Removing Cloudflare Apps            Cloudflare Custom Pages         Overview     Configuring Custom Pages (Error and Challenge)            Cloudflare Stream         Overview     Delivering Videos with Cloudflare                Partners Support         Overview     Reduce data transfer (egress costs) between Azure and Cloudflare            Third-Party Software         Overview        Content Management System (CMS)         Overview     Caching HTML with Drupal     Caching Static HTML with WordPressWooCommerce     Can I use WordPress caching plugins like Super Cache or W3 Total Cache (W3TC) with Cloudflare     Cloudflare and Joomla Recommended First Steps     Cloudflare WordPress Plugin Automatic Cache Management     How do I enable HTTP2 Server Push in WordPress     Improving web security for content management systems like WordPress     Speed Up WordPress and Improve Performance     Using Cloudflare and Drupal Five Easy Recommended Steps     What settings are applied when I click Optimize Cloudflare for WordPress in Cloudflare's WordPress plugin     WordPress Jetpack and Cloudflare     WordPress.com and Cloudflare            e-Commerce         Overview     Caching Static HTML with Magento (Business and Enterprise only)            Forum Software         Overview     Using Cloudflare with various forums            Others         Overview     Configure Cloudflare and Heroku over HTTPS                Troubleshooting         Overview        Cloudflare Errors         Overview     Troubleshooting Cloudflare 10XXX errors     Troubleshooting Cloudflare 1XXX errors     Troubleshooting Cloudflare 5XX errors     Troubleshooting other errors            General Troubleshooting         Overview     Gathering information for troubleshooting sites     Troubleshooting crawl errors            HTTP Status Codes         Overview     1xx Informational     2xx Success     3xx Redirection     4xx Client Error     HTTP Status Codes            Restoring Visitor IPs         Overview     Restoring original visitor IPs            Disruptive Maintenance         Overview               \n\t\t(() => {\n\t\t\tconst scroller = document.getElementById('starlight__sidebar');\n\t\t\tif (!window._starlightScrollRestore || !scroller) return;\n\t\t\tscroller.scrollTop = window._starlightScrollRestore;\n\t\t\tdelete window._starlightScrollRestore;\n\t\t})();\n\t        Products  Learning  Status  Support  Log in   GitHub X YouTube       Select theme    DarkLightAuto        \n\tStarlightThemeProvider.updatePickers();\n            const a=document.getElementById(\"starlight__sidebar\"),n=a?.querySelector(\"sl-sidebar-state-persist\"),o=\"sl-sidebar-state\",i=()=>{let t=[];const e=n?.dataset.hash||\"\";try{const s=sessionStorage.getItem(o),r=JSON.parse(s||\"{}\");Array.isArray(r.open)&&r.hash===e&&(t=r.open)}catch{}return{hash:e,open:t,scroll:a?.scrollTop||0}},c=t=>{try{sessionStorage.setItem(o,JSON.stringify(t))}catch{}},d=()=>c(i()),l=(t,e)=>{const s=i();s.open[e]=t,c(s)};n?.addEventListener(\"click\",t=>{if(!(t.target instanceof Element))return;const e=t.target.closest(\"summary\")?.closest(\"details\");if(!e)return;const s=e.querySelector(\"sl-sidebar-restore\"),r=parseInt(s?.dataset.index||\"\");isNaN(r)||l(!e.open,r)});addEventListener(\"visibilitychange\",()=>{document.visibilityState===\"hidden\"&&d()});addEventListener(\"pageHide\",d);    On this page    Overview     mod_remoteip     mod_cloudflare     Installing     Removing        Web server instructions     Apache 2.4     Nginx     EasyApache and cPanel     Lighttpd     LiteSpeed server     Microsoft IIS     Tomcat 7     Magento     IPB (Invision Power Board)     PHPBB     MyBB forums     Vanilla forums     XenForo     PunBB     Livezilla     Datalife Engine     TYPO3     VestaCP     node.js     HAProxy     Envoy Gateway        Related Resources     On this page   Overview     mod_remoteip     mod_cloudflare     Installing     Removing        Web server instructions     Apache 2.4     Nginx     EasyApache and cPanel     Lighttpd     LiteSpeed server     Microsoft IIS     Tomcat 7     Magento     IPB (Invision Power Board)     PHPBB     MyBB forums     Vanilla forums     XenForo     PunBB     Livezilla     Datalife Engine     TYPO3     VestaCP     node.js     HAProxy     Envoy Gateway        Related Resources         Was this helpful?   Yes      No        What did you like?     Accurate    Easy to understand    Solved my problem    Helped me decide to use the product    Other        What went wrong?     Hard to understand    Incorrect information    Missing the information    Other        Thank you for helping improve Cloudflare's documentation!                    Products        â€¦       Support        Troubleshooting        Restoring Visitor IPs        Restoring original visitor IPs        {\"@context\":\"https://schema.org\",\"@type\":\"BreadcrumbList\",\"itemListElement\":[{\"@type\":\"ListItem\",\"position\":1,\"item\":{\"@id\":\"/products/\",\"name\":\"Products\"}},{\"@type\":\"ListItem\",\"position\":2,\"item\":{\"@id\":\"/support/\",\"name\":\"Support\"}},{\"@type\":\"ListItem\",\"position\":3,\"item\":{\"@id\":\"/support/troubleshooting/\",\"name\":\"Troubleshooting\"}},{\"@type\":\"ListItem\",\"position\":4,\"item\":{\"@id\":\"/support/troubleshooting/restoring-visitor-ips/\",\"name\":\"Restoring Visitor IPs\"}},{\"@type\":\"ListItem\",\"position\":5,\"item\":{\"@id\":\"/support/troubleshooting/restoring-visitor-ips/restoring-original-visitor-ips/\",\"name\":\"Restoring original visitor IPs\"}}]} class t extends HTMLElement{constructor(){super(),this.isManualToggle=!1,this.breadcrumbs=null,this.mainBemClass=null,this.totalWidth=0,this.resizeObserver=null,this.handleTruncatedButtonClick=()=>{this.breadcrumbs?.classList.remove(\"is-truncated\"),this.isManualToggle=!0},this.mainBemClass=this.dataset.mainBemClass||null;const e=this.dataset.id;!(\"truncated\"in this.dataset)||!e||(this.breadcrumbs=document.getElementById(e),this.initializeCrumbs(),this.setupResizeObserver())}initializeCrumbs(){this.breadcrumbs?.querySelectorAll(`.${this.mainBemClass}__crumb`)?.forEach(s=>{this.totalWidth+=s.offsetWidth})}setupResizeObserver(){this.resizeObserver=new ResizeObserver(e=>{e.forEach(s=>{this.checkOverflow(s.target.clientWidth)})}),this.breadcrumbs&&this.resizeObserver.observe(this.breadcrumbs)}connectedCallback(){this.showHiddenCrumbs()}disconnectedCallback(){this.resizeObserver&&this.breadcrumbs&&(this.resizeObserver.unobserve(this.breadcrumbs),this.resizeObserver.disconnect())}toggleTruncated(e){this.breadcrumbs?.classList.toggle(\"is-truncated\",e)}showHiddenCrumbs(){const e=this.breadcrumbs?.querySelector(`.${this.mainBemClass}__truncated-button`);e?.removeEventListener(\"click\",this.handleTruncatedButtonClick),e?.addEventListener(\"click\",this.handleTruncatedButtonClick.bind(this))}checkOverflow(e){const s=this.totalWidth>e&&!this.isManualToggle;this.toggleTruncated(s),s||(this.isManualToggle=!1)}}customElements.get(\"astro-breadcrumbs\")||customElements.define(\"astro-breadcrumbs\",t);Restoring original visitor IPs                             const L=\"starlight-image-zoom-zoomable\",w=window.requestIdleCallback??(y=>setTimeout(y,1));customElements.define(\"starlight-image-zoom\",class f extends HTMLElement{#t;#i=[];#o;#s=this.querySelector(\"template\");#e={image:\"starlight-image-zoom-image\",opened:\"starlight-image-zoom-opened\",source:\"starlight-image-zoom-source\",transition:\"starlight-image-zoom-transition\"};#r=\"zoomTransform\";static#u=!1;constructor(){super();const t=()=>{w(()=>{const e=[...document.querySelectorAll(L)];e.length!==0&&(this.#m(e),document.addEventListener(\"click\",this.#d),window.addEventListener(\"resize\",this.#a))})};window.addEventListener(\"DOMContentLoaded\",t,{once:!0}),document.addEventListener(\"astro:after-preparation\",()=>{document.removeEventListener(\"click\",this.#d),window.removeEventListener(\"resize\",this.#a)},{once:!0}),f.#u||=document.addEventListener(\"astro:after-swap\",t)===void 0}#m(t){for(const e of t){const n=e.querySelector(\"img\");n&&(this.#i.push(n),e.querySelector(\"button\")?.addEventListener(\"click\",i=>{i.stopPropagation(),this.#l(n)}))}}#d=({target:t})=>{if(!(t instanceof HTMLElement&&t.closest(\"figcaption\"))){if(this.#t){this.#n();return}t instanceof HTMLImageElement&&this.#i.includes(t)&&this.#l(t)}};#a=()=>{this.#n(!0)};#c=()=>{this.#n()};#p=t=>{t.preventDefault(),this.#n()};#l(t){if(!this.#s||this.#t)return;this.#o=document.activeElement;const e=document.createElement(\"div\");e.append(this.#s.content.cloneNode(!0));const n=e.querySelector(\"dialog\"),i=n?.querySelector(\"figure\");if(!n||!i)return;const r={overflow:document.body.style.overflow,width:document.body.style.width},d=document.body.clientWidth;document.body.style.overflow=\"hidden\",document.body.style.width=`${d}px`,document.querySelector(\"header\")?.style.setProperty(\"padding-inline-end\",`calc(var(--sl-nav-pad-x) + ${window.innerWidth-d}px)`);const s=this.#f(t);t.classList.add(this.#e.source),s.classList.add(this.#e.image),i.append(s),this.#w(t.getAttribute(\"alt\"),i),document.body.append(e),document.addEventListener(\"wheel\",this.#c,{once:!0}),n.addEventListener(\"cancel\",this.#p),n.showModal(),w(()=>{s.style.transform=\"\",document.body.classList.add(this.#e.opened)}),this.#t={body:r,dialog:n,image:t,zoomedImage:s}}#n(t=!1){if(window.removeEventListener(\"wheel\",this.#c),!this.#t)return;const{zoomedImage:e}=this.#t;e.style.transform=e.dataset[this.#r]??\"\",document.body.classList.add(this.#e.transition),document.body.classList.remove(this.#e.opened);const{matches:n}=window.matchMedia(\"(prefers-reduced-motion: reduce)\");t||n?this.#h():e.addEventListener(\"transitionend\",this.#h,{once:!0})}#h=()=>{if(!this.#t)return;const{dialog:t,image:e}=this.#t;document.body.classList.remove(this.#e.transition),e.classList.remove(this.#e.source),t.parentElement?.remove(),document.body.style.overflow=this.#t.body.overflow,document.body.style.width=this.#t.body.width,document.querySelector(\"header\")?.style.setProperty(\"padding-inline-end\",\"var(--sl-nav-pad-x)\"),this.#t=void 0,this.#o instanceof HTMLElement&&this.#o.focus()};#w(t,e){if(Object.hasOwn(this.dataset,\"hideCaption\")||(t=t?.trim()??\"\",t.length===0))return;const n=document.createElement(\"figcaption\");n.ariaHidden=\"true\",n.textContent=t,e.append(n)}#f(t){const e=t.getBoundingClientRect(),n=this.#y(t),i=n?window.innerWidth:t.naturalWidth,r=n?window.innerHeight:t.naturalHeight,d=Math.min(window.innerWidth,i),s=Math.min(window.innerHeight,r),l=Math.min(d/i,s/r),a=(n?window.innerWidth:t.naturalWidth)*l,c=(n?window.innerHeight:t.naturalHeight)*l,h=(window.innerHeight-c)/2,u=(window.innerWidth-a)/2,o=t.cloneNode(!0);o.removeAttribute(\"id\"),o.style.position=\"absolute\",o.style.width=`${a}px`,o.style.height=`${c}px`,o.style.top=`${h}px`,o.style.left=`${u}px`,o.style.transform=\"\";const m=e.width/a,p=e.height/c,g=(-u+(e.width-a)/2+e.left)/m,v=(-h+(e.height-c)/2+e.top)/p;return o.style.transform=`scale(${m}, ${p}) translate3d(${g}px, ${v}px, 0)`,o.dataset[this.#r]=o.style.transform,t.parentElement?.tagName===\"PICTURE\"&&t.currentSrc&&(o.src=t.currentSrc),o}#y(t){return t.currentSrc.toLowerCase().endsWith(\".svg\")}});  When yourÂ website traffic is routed through the Cloudflare network â†—, we act as a reverse proxy. This allows Cloudflare to speed up page load time by routing packets more efficiently and caching static resources (images, JavaScript, CSS, etc.). As a result, when responding to requests and logging them, your origin server returns aÂ Cloudflare IP address â†—.\nFor example, if you install applications that depend on the incoming IP address of the original visitor, a Cloudflare IP address is logged by default. The original visitor IP address appears in an appended HTTP header calledÂ CF-Connecting-IP. By following our web server instructions, you can log the original visitor IP address at your origin server. If this HTTP header is not available when requests reach your origin server, check your Transform Rules and Managed Transforms configuration.\nNoteIf Pseudo IPv4 is set to Overwrite Headers - Cloudflare overwrites the existing Cf-Connecting-IP and X-Forwarded-For headers with a pseudo IPv4 address while preserving the real IPv6 address in CF-Connecting-IPv6 header.\nThe diagram below illustrates the different ways that IP addresses are handled with and without Cloudflare.\n\nWarningCloudflare no longer updates and supports mod_cloudflare, starting\nwith versions Debian 9 and Ubuntu 18.04 LTS of the Linux\noperating system. We now recommend\nmod_remoteip â†—\nfor customers using Apache web servers. Customers who are interested in\nbuilding the mod_cloudflare package can download the\ncodebase â†— from GitHub.\n\nmod_remoteip\nCloudflare no longer updates and supportsÂ mod_cloudflare.Â However, ifÂ you are using an Apache web server with an operating system such asÂ Ubuntu Server 18.04Â andÂ Debian 9 Stretch, you can useÂ mod_remoteipÂ to log your visitorâ€™s original IP address.\nAs this module was created by an outside party, we can't provide technical support for issues related to the plugin.\nTo installÂ mod_remoteipÂ on your Apache web server:\n\nEnableÂ mod_remoteipÂ by issuing the following command:\n\nTerminal windowsudo a2enmod remoteip\n\nUpdate the site configuration to includeÂ RemoteIPHeader CF-Connecting-IP, e.g.Â /etc/apache2/sites-available/000-default.conf\n\nServerAdmin webmaster@localhostDocumentRoot /var/www/htmlServerName remoteip.andy.supportRemoteIPHeader CF-Connecting-IPErrorLog ${APACHE_LOG_DIR}/error.logCustomLog ${APACHE_LOG_DIR}/access.log combined\n\nUpdate combinedÂ LogFormatÂ entry inÂ apache.conf, replacingÂ %hÂ withÂ %a inÂ /etc/apache2/apache2.conf.Â For example, if your currentÂ LogFormatÂ appeared as follows\n\nLogFormat \"%h %l %u %t \\\"%r\\\" %>s %O \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\"\" combined\nyou would updateÂ LogFormatÂ to the following:\nLogFormat \"%a %l %u %t \\\"%r\\\" %>s %O \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\"\" combined\n\nDefine trusted proxy addresses by creatingÂ /etc/apache2/conf-available/remoteip.confÂ by entering the following code andÂ Cloudflare IPs â†—:\n\nRemoteIPHeader CF-Connecting-IPRemoteIPTrustedProxy 192.0.2.1 (example IP address)RemoteIPTrustedProxy 192.0.2.2 (example IP address)(repeat for all Cloudflare IPs listed at https://www.cloudflare.com/ips/)\n\nEnable Apache configuration:\n\nTerminal windowsudo a2enconf remoteip\n.expressive-code:has(figure.code-output){margin-top:0 !important}.expressive-code .code-output .copy{display:none !important}.expressive-code .code-output > pre{border-top-width:0 !important;background:var(--sl-color-gray-6) !important}.expressive-code .code-output > pre > code{user-select:none;transition:opacity 0.5s ease}.expressive-code .code-output > pre > code:hover{cursor:default;opacity:0.5}Enabling conf remoteip.To activate the new configuration, you need to run:service apache2 reload\n\nTest Apache configuration:\n\nTerminal windowsudo apache2ctl configtest\nSyntax OK\n\nRestart Apache:\n\nTerminal windowsudo systemctl restart apache2\nNoteFor more information on mod_remoteip, refer to the Apache\ndocumentation â†—.\n\nmod_cloudflare\nWarningCloudflare no longer updates and supports mod_cloudflare, starting\nwith versions Debian 9 and Ubuntu 18.04 LTS of the Linux\noperating system. We now recommend\nmod_remoteip â†—\nfor customers using Apache web servers. Customers who are interested in\nbuilding the mod_cloudflare package can download the\ncodebase â†— from GitHub.\nInstalling\nThere are two methods for installing mod_cloudflare: by downloading the Apache extension from GitHub or by adding code to your origin web server.\nDownloading packets or scripts from GitHub\nIf you are using an Apache web server, you can download mod_cloudflare from GitHub â†—.\nAdding code to your origin web server\nIf you can't install mod_cloudflare, or if there is no Cloudflare plugin available for your content management system platform to restore original visitor IP, add this code to your origin web server in or before the <body> tag on any page that needs the original visitor IPs:\n<?php if (isset($_SERVER['HTTP_CF_CONNECTING_IP'])) $_SERVER['REMOTE_ADDR'] = $_SERVER['HTTP_CF_CONNECTING_IP'];?>\nThis command will only make the IP address available to scripts that need it. It doesnâ€™t store the IP in your actual server logs.\nRemoving\nApache\nTo removeÂ mod_cloudflare, you should comment out the Apache config line that loadsÂ mod_cloudflare.\nThis varies based on your Linux distribution, but for most people, if you look inÂ /etc/apache2, you should be able to search to find the line:\nLoadModule cloudflare_module\nComment or remove this line, then restart apache, andÂ mod_cloudflareÂ should be gone.\nIf you are running Ubuntu or Debian, you should see.\nfile/etc/apache2/mods-enabled/cloudflare.load\ndelete this file to removeÂ mod_cloudflare, then restart Apache.\nNginx\nmod_cloudflare is not needed for Nginx. Use the ngx_http_realip_module NGINX module â†—Â and the configuration parameters described in the Web server instructions â†— instead.\n\nWeb server instructions\nRefer below for instructions on how to configure your web serverÂ to log original visitor IPs based on your web server type:\nApache 2.4\nWarningCloudflare no longer updates and supports mod_cloudflare, starting\nwith versions Debian 9 and Ubuntu 18.04 LTS of the Linux\noperating system. We now recommend\nmod_remoteip â†—\nfor customers using Apache web servers. Customers who are interested in\nbuilding the mod_cloudflare package can download the\ncodebase â†— from GitHub.\n\nMake sure the following is installed:\n\nRed Hat/Fedorasudo yum install httpd-devel libtool git\nDebian/Ubuntusudo apt-get install apache2-dev libtool git\n\n\nClone the following for the most recent build ofÂ mod_cloudflare:\n\nRed Hat/Fedora/Debian/Ubuntu:git clone https://github.com/cloudflare/mod_cloudflare.git; cd mod_cloudflare\n\n\nUse the Apache extension tool to convert the .c file into a module:\n\nRed Hat/Fedora/Debian/Ubuntu:apxs -a -i -c mod_cloudflare.c\n\n\nRestart and verify the module is active:\n\nRed Hat/Fedoraservice httpd restart; httpd -M|grep cloudflare\nDebian/Ubuntu:sudo apachectl restart; apache2ctl -M|grep cloudflare\n\n\nIf your web server is behind a load balancer, add the following line to your Apache configuration (httpd.conf usually) and replace 123.123.123.123 with your load balancer's IP address:\n\nIfModule cloudflare_moduleCloudFlareRemoteIPHeader X-Forwarded-ForCloudFlareRemoteIPTrustedProxy [insert your load balancerâ€™s IP address]DenyAllButCloudFlare/IfModule\nNginx\nUse the ngx_http_realip_module Nginx module â†—Â and the following configuration parameters:\nset_real_ip_from 192.0.2.1 (example IP address)\n#use any of the following two\nreal_ip_header CF-Connecting-IP;#real_ip_header X-Forwarded-For;\nThat list of prefixes needs to be updated regularly, and we publish the full list inÂ Cloudflare IP addresses â†—.\nNoteTo Include the original visitor IP in your logs, add the variables\n$http_cf_connecting_ip and $http_x_forwarded_for in the\nlog_format directive.\nAlso refer to:Â Cloudflare and NGINX â†—.\nEasyApache and cPanel\nWarningCloudflare no longer updates and supports mod_cloudflare, starting\nwith versions Debian 9 and Ubuntu 18.04 LTS of the Linux\noperating system. We now recommend\nmod_remoteip â†—\nfor customers using Apache web servers. Customers who are interested in\nbuilding the mod_cloudflare package can download the\ncodebase â†— from GitHub.\n\nRun the following script to install mod_cloudflare as part of EasyApache: bash <(curl -s https://raw.githubusercontent.com/cloudflare/mod_cloudflare/master/EasyApache/installer.sh)\nUpon installing, you will need to recompile your Apache with the new mod_cloudflare plugin.\nTo fix this, open up your Apache configuration. This can typically be found inÂ /etc/apache2/apache2.conf,Â /etc/httpd/httpd.conf,Â /usr/local/apache/conf/httpd.confÂ or another location depending on configuration. If you're unsure, ask your hosting provider.\nAt the very end add:CloudflareRemoteIPTrustedProxy {LOOPBACK_ADDRESS} So, if your server is located at 127.0.0.1, it will look like:CloudflareRemoteIPTrustedProxy 127.0.0.1\nIf you have more than one server to add to the trusted proxy list, you can add them at the end: CloudflareRemoteIPTrustedProxy 127.0.0.1 127.0.0.2\n\nLighttpd\nTo have Lighttpd automatically rewrite the server IP for the access logs and for your application, you can follow one of the two solutions below.\n\nOpen yourÂ lighttpd.confÂ file and addÂ mod_extforwardÂ to theÂ server.modulesÂ list. It must comeÂ afterÂ mod_accesslogÂ to show the real IP in the access logs\nAdd the following code block anywhere in theÂ lighttpd.confÂ file after the server modules list and then restart Lighttpd\n\n$HTTP[\"remoteip\"] == \"192.2.0.1 (example IP address)\"{extforward.forwarder = ( \"all\" => \"trust\" )extforward.headers = (\"CF-Connecting-IP\")}\nNoteIf your origin connects to the Internet with IPv6,\n$HTTP[\"remoteip\"], which is required for matching the remote IP\nranges does not work when IPv6 is enabled. Using the above method will\nnot work when trying to forward IP ranges. Add the following lines to\nlighttpd.conf as an alternative solution:\nextforward.forwarder = ( \"all\" => \"trust\" ) extforward.headers = (\"CF-Connecting-IP\")\nLiteSpeed server\n\nGo to your LiteSpeed Web Admin Console.\nEnable the option Use Client IP in Header in Configuration.\nOnce enabled, your access logs will now show the correct IP addresses, and even PHP's $_SERVER['REMOTE_ADDR'] variable will contain the client real IP address, instead of a Cloudflare IP address, which in itself will resolve most problems you could hit when enabling Cloudflare on PHP-enabled web sites (like WordPress or vBulletin installs).\n\nMicrosoft IIS\nFor IIS 7 - 8:\nFollow the directions inÂ the Microsoft Community â†—.\nFor IIS 8.5 - 10:\nFrom IIS 8.5 onwards, custom logging is a built-in option. Refer to IIS Enhanced Logging â†—.\n\n\nIn IIS Manager, double click onÂ LoggingÂ in theÂ ActionsÂ menu of the site you are working on.\n\n\nAfter this launches, selectÂ W3CÂ as the format and then clickÂ Select FieldsÂ next to the format drop-down in theÂ Log FileÂ sub-section.\n\n\nClick onÂ Add FieldÂ and add inÂ CF-Connecting-IPÂ header.\n\n\nClickÂ Ok. You should see your new entry reflected underÂ Custom Fields. Click onÂ ApplyÂ when you are back in theÂ LoggingÂ window.\n\n\nIf this is successful, the log file should now have an underscore:You should also see the change in the fields:\n\n\nRestart the site, then W3SVC, then the entire instance if the change doesnâ€™t reflect immediately.When using enhanced logging in IIS 8.5+, itÂ does not restoreÂ original visitor IP at the application level.\n\n\nTomcat 7\nTo have Tomcat7 automatically restore the original visitor IP to your access logs and application you will need to addÂ %{CF-Connecting-IP}iÂ into your log schema.\nAs an example, you could add the below block to yourÂ server.xmlÂ file.\n<Valve className=\"org.apache.catalina.valves.AccessLogValve\" directory=\"logs\" prefix=\"localhost_access_log.\" suffix=\".txt\" pattern=\"%{CF-Connecting-IP}i - %h %u %t - &quot;%r&quot; - %s - %b - %{CF-RAY}i\"/>\nWhich would result in your logs looking like this:\nVisitor IP - Cloudflare IP - [04/Dec/2014:23:18:15 -0500] - \"GET / HTTP/1.1\" - 200 - 1895 - 193d704b85200296-SJC\nMagento\nRefer to this third-party tutorial on restoring original visitor IP withÂ Magento and Cloudflare â†—.\nSimilarly, Cloudflare did not write thisÂ Magento extension â†—, but some of our customers have found it helpful.\nAs this plugin was created by an outside party, we can't provide technical support for issues related to the plugin.\nIPB (Invision Power Board)\nTo enable correct IP matching when running an Invision Power Board 3 installation through Cloudflare, follow these directions:\nLog into your IPB installation's ACP.\n\nClickÂ System.\nUnder Overview, clickÂ Security.\nUnder Security Center, clickÂ Security Settings.Check thatÂ Trust IP addresses provided by proxies?Â is green.\n\nIPB4 description ofÂ Trust IP addresses provided by proxies?\nIf your network environment means requests are handled through a proxy (such as in an intranet situation in an office or university, or on a load-balanced server cluster), you may need to enable this setting so that the correct IP address is used. However, when enabled, a malicious user can abuse the system to provide a fake IP address. In most environments, this setting should be left off.\nPHPBB\nIf you are using an Apache server, then we would recommend installing mod_remoteip â†—Â to restore the visitor IP back to your logs.\nIf you do not have access to your server to install a mod, then you may be able to modify the core â†—.\nMyBB forums\nMore recent versions of MyBB include a Scrutinize User's IP address option.\nAdmin CP > Configuration > Server and Optimization Options > Scrutinize User's IP address? > Yes\nAlternatively, you may install theÂ Cloudflare management plugin â†—Â available for MyBB 1.6.\nMyBB 1.6.0, 1.6.1, 1.6.2, or 1.6.3\n\nNavigate toÂ ./inc/functions.php.\nGo to line 2790.\nReplace:if(isset($_SERVER['REMOTE_ADDR']))With:if(isset($_SERVER['HTTP_CF_CONNECTING_IP']))\nThen, replace:$ip = $_SERVER['REMOTE_ADDR'];With:$ip = $_SERVER['HTTP_CF_CONNECTING_IP'];\n\nVanilla forums\nA member of the Vanilla team has written aÂ Cloudflare plugin for Vanilla â†—Â to restore original visitor IP to the log files for self-hosted sites.\nAs this plugin was created by an outside party, we can't provide technical support for issues related to the plugin.MediaWiki\n\nOpenÂ includes/GlobalFunctions.php. At approximately line 370, change the following:$forward = \"\\t(proxied via {$_SERVER['REMOTE_ADDR']}{$forward})\";to$forward = \"\\t(proxied via {$_SERVER['HTTP_CF_CONNECTING_IP']}{$forward})\";\nOpenÂ includes/ProxyTools.php. At approximately line 79, find:if ( isset( $_SERVER['REMOTE_ADDR'] ) ){and replace with:if ( isset( $_SERVER['HTTP_CF_CONNECTING_IP'] ) ){The second step only applies to MediaWiki versions 1.18.0 and older. Newer versions of MediaWiki have completely rewritten ProxyTools.php and the following code is no longer present.\nFind at approximately line 80:$ipchain = array( IP::canonicalize($_SERVER['REMOTE_ADDR']) );Save and upload to your origin web server.\n\nFor versions around 1.27.1:\n\nGo to line 1232 inÂ GlobalFunctions.php, changeÂ REMOTE_ADDRÂ toÂ HTTP_CF_CONNECTING_IP.\nNext, go toÂ WebRequest.php, in lines 1151 to line 1159, changeÂ REMOTE_ADDRÂ toÂ HTTP_CF_CONNECTING_IP.\n\nXenForo\nA XenForo user has created aÂ plugin for Cloudflare â†—.\nAs this plugin was created by an outside party, we can't provide technical support for issues related to the plugin.\n\nOpenÂ library/config.php.\nAt the end, add:if (isset($_SERVER['HTTP_CF_CONNECTING_IP'])) { $_SERVER['REMOTE_ADDR'] = $_SERVER['HTTP_CF_CONNECTING_IP'];}\nUpload and overwrite.\n\nPunBB\nAn outside party has created aÂ module for Cloudflare and PunBB â†—Â that will restore original visitor IP.\nAs this plugin was created by an outside party, we can't provide technical support for issues related to the plugin.Cherokee server\n\nLaunchÂ cherokee-adminÂ on your server.\nNavigate to theÂ Cherokee Administration interfaceÂ in your web browser.\nSelect theÂ Virtual ServerÂ for the domain that is being serviced by Cloudflare.\nOn theÂ LoggingÂ tab for your selectedÂ Virtual Server, enable Accept Forwarded IPs.\nIn theÂ Accept from HostsÂ box, enterÂ Cloudflare's IP addresses â†—.\n\nLivezilla\nYou can fix the IP address by changing theÂ PHP IP Server ParamÂ field on the Livezilla server configuration toÂ HTTP_CF_CONNECTING_IP.\nDatalife Engine\nTo restore visitor IP to DataLife Engine:\n\nOpen:/engine/inc/include/functions.inc.phpFind:$db_ip_split = explode( \".\", $_SERVER['REMOTE_ADDR'] );Change to:$db_ip_split = explode(\".\", $_SERVER['HTTP_CF_CONNECTING_IP'] );\nFind:$ip_split = explode( \".\", $_SERVER['REMOTE_ADDR'] );Change to:$ip_split = explode(\".\", $_SERVER['HTTP_CF_CONNECTING_IP'] );\nOpen:/engine/modules/addcomments.phpFind:$_SERVER['REMOTE_ADDR'],Change to:$_SERVER['HTTP_CF_CONNECTING_IP'],\nFind:$db_ip_split = explode( \".\", $_SERVER['REMOTE_ADDR'] );Change to:$db_ip_split = explode( \".\", $_SERVER['HTTP_CF_CONNECTING_IP'] );\n\nTYPO3\nAn outside developer has created aÂ Cloudflare extension for TYPO3 â†—Â that will restore original visitor IP to your logs. The extension will also give the ability to clear your Cloudflare cache.\nAs this plugin was created by an outside party, we can't provide technical support for issues related to the plugin.\nVestaCP\nIf you use the hosting control panel VestaCP, you have both Nginx and Apache running on your server. Requests are proxied through Nginx before going to Apache.\nBecause of this Nginx proxy, you actually need to the instructions to configure Nginx to return the real visitor IP address.Â Mod_remoteip â†—Â for Apache is not needed unless you disable the Nginx server for some requests. AddingÂ mod_remoteip â†—Â to Apache will not conflict with the Nginx server configuration.\nnode.js\nAn outside developer has created a module to restore visitor IP calledÂ node_cloudflare. â†—\nHAProxy\nIn order to extract the original client IP in the X_FORWARDED_FOR header, you need to use the following configuration in HAProxy:\n\nCreate a text file CF_ips.lst containing all IP ranges from https://www.cloudflare.com/en-gb/ips/ â†—\nEnsure to disable option forwardfor in HAProxy\n\nHAProxy config:\nacl from_cf src -f /path/to/CF_ips.lstacl cf_ip_hdr req.hdr(CF-Connecting-IP) -m foundhttp-request set-header X-Forwarded-For %[req.hdr(CF-Connecting-IP)] if from_cf cf_ip_hdr\nEnvoy Gateway\nTo extract the original client IP for your Envoy Gateway, set a Client Traffic Policy â†— to look for the custom CF-Connecting-IP header.\nTruncated Client Traffic Policy exampleclientIPDetection:    customHeader:        name: CF-Connecting-IP        failClosed: true\nFor more details, refer to Custom header original IP detection extension â†—.\n\nRelated Resources\n\nHTTP request headers\nTransform Rules\n     Was this helpful?   Yes      No        What did you like?     Accurate    Easy to understand    Solved my problem    Helped me decide to use the product    Other        What went wrong?     Hard to understand    Incorrect information    Missing the information    Other        Thank you for helping improve Cloudflare's documentation!    class r extends HTMLElement{connectedCallback(){const d={'[data-icon=\"material-symbols:thumb-up-outline-rounded\"]':\"#feedback-yes\",'[data-icon=\"material-symbols:thumb-down-outline-rounded\"]':\"#feedback-no\"},s=this.querySelector(\"#feedback-thumbs\"),o=this.querySelector(\"#feedback-thanks\");if(!(!s||!o))for(const[i,n]of Object.entries(d))this.querySelector(i)?.addEventListener(\"click\",()=>{s.classList.add(\"hidden\");const e=this.querySelector(n);if(!e)return;e.classList.remove(\"hidden\");const a=e.querySelector(\"form\");a&&a.addEventListener(\"submit\",async c=>{c.preventDefault();const t=new FormData(c.target);t.set(\"page\",window.location.pathname),t.set(\"option\",n.split(\"-\")[1]),fetch(\"https://feedback.developers.cloudflare.com\",{method:\"POST\",body:t}),e.classList.add(\"hidden\"),o.classList.remove(\"hidden\")})})}}customElements.define(\"feedback-prompt\",r);       Edit page          Cloudflare DashboardDiscordCommunityLearning CenterSupport Portal\n\t\t\t\tfunction OptanonWrapper() {}\n\t\t\t  Cookie Settings",
  "custom_id": "R5mLuARigtEcESKKLK17UKugXMUjMrKq813EfUmmdJSGHJNTrRR01RBykTc7bMW4"
}